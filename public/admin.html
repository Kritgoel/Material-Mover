<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin - Material Mover</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
      .admin-grid { display: grid; gap: 20px; margin: 20px 0; }
      .admin-card { background: var(--panel); padding: 16px; border-radius: 12px; }
      .user-list { margin: 20px 0; }
      .user-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
      .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; background: #e5e7eb; }
      .role-badge.admin { background: #fde68a; }
      .role-badge.seller { background: #bfdbfe; }
    </style>
  </head>
  <body>
    <header class="site-header">
      <h1>Admin Dashboard</h1>
      <nav>
        <a href="/">Home</a>
        <a id="logout" href="#">Logout</a>
      </nav>
    </header>
    <main class="container">
      <div class="admin-grid">
        <section class="admin-card">
          <h3>Create New User</h3>
          <form id="createUserForm" class="auth-form">
            <input type="email" id="newEmail" placeholder="Email" required>
            <input type="password" id="newPassword" placeholder="Password" required>
            <select id="newRole">
              <option value="buyer">Buyer</option>
              <option value="seller">Seller</option>
              <option value="admin">Admin</option>
            </select>
            <button type="submit">Create User</button>
          </form>
        </section>

        <section class="admin-card">
          <h3>Users</h3>
          <div id="userList" class="user-list">Loading...</div>
        </section>

        <section class="admin-card">
            <h3>System Health</h3>
            <button id="health">Check API</button>
            <pre id="out"></pre>
        </section>
        
          <section class="admin-card">
            <h3>Search & Edit Product</h3>
            <div style="display:flex;gap:8px;margin-bottom:8px;">
              <input id="productQuery" placeholder="Search by title or id" style="flex:1" />
              <button id="productSearchBtn">Search</button>
            </div>
            <div id="productResults">Enter a query and press Search</div>

            <form id="editProductForm" style="display:none;margin-top:12px;">
              <input type="text" id="editId" readonly style="display:none" />
              <label>Title</label>
              <input type="text" id="editTitle" required />
              <label>Description</label>
              <textarea id="editDescription" rows="3" required></textarea>
              <label>Price (â‚¹)</label>
              <input type="number" id="editPrice" min="0" step="0.01" required />
              <label>Quantity</label>
              <input type="number" id="editQuantity" min="0" required />
              <label>Category</label>
              <input type="text" id="editCategory" required />
              <label>Address *</label>
              <input type="text" id="editAddress" required />
              <label>Phone Number *</label>
              <input type="tel" id="editPhone" required />
              <label>Image URL</label>
              <input type="text" id="editImage" />
              <div style="margin-top:8px;display:flex;gap:8px;">
                <button id="saveProductBtn" type="button">Save</button>
                <button id="cancelEditBtn" type="button">Cancel</button>
              </div>
            </form>
          </section>
      </div>
    </main>
    <script>
      // Auth check
      if (!localStorage.getItem('token') || localStorage.getItem('role') !== 'admin') {
        alert('Please login as admin'); location.href = '/login.html';
      }

      const token = localStorage.getItem('token');
      const headers = { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' };

      // Load users
      async function loadUsers() {
        try {
          const r = await fetch('/api/auth/users', { headers });
          if (!r.ok) throw new Error('Failed to load users');
          const users = await r.json();
          const html = users.map(u => `
            <div class="user-item">
              <div>
                ${u.email}
                <span class="role-badge ${u.role}">${u.role}</span>
              </div>
              <div>
                ${u.role !== 'admin' ? `
                  <button onclick="updateRole('${u._id}', 'admin')" class="small">Make Admin</button>
                ` : ''}
                ${u.email !== (localStorage.getItem('email') || '') ? `
                  <button onclick="deleteUser('${u._id}')" class="small" style="margin-left:8px;background:#fca5a5">Delete</button>
                ` : ''}
              </div>
            </div>
          `).join('');
          document.getElementById('userList').innerHTML = html || 'No users found';
        } catch (err) {
          document.getElementById('userList').innerHTML = 'Error loading users: ' + err.message;
        }
      }

      // Create user
      document.getElementById('createUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('newEmail').value;
        const password = document.getElementById('newPassword').value;
        const role = document.getElementById('newRole').value;
        try {
          const r = await fetch('/api/auth/create-user', {
            method: 'POST',
            headers,
            body: JSON.stringify({ email, password, role })
          });
          if (!r.ok) throw new Error('Failed to create user');
          alert('User created successfully');
          loadUsers();
          e.target.reset();
        } catch (err) {
          alert('Error creating user: ' + err.message);
        }
      });

      // Update role
      async function updateRole(userId, newRole) {
        try {
          const r = await fetch('/api/auth/update-role', {
            method: 'POST',
            headers,
            body: JSON.stringify({ userId, role: newRole })
          });
          if (!r.ok) throw new Error('Failed to update role');
          alert('Role updated successfully');
          loadUsers();
        } catch (err) {
          alert('Error updating role: ' + err.message);
        }
      }

      // Logout
      document.getElementById('logout').addEventListener('click', () => {
        localStorage.clear();
        location.href = '/';
      });

      // Health check
      document.getElementById('health').addEventListener('click', async () => {
        const r = await fetch('/api/health');
        document.getElementById('out').innerText = JSON.stringify(await r.json(), null, 2);
      });

      // Product search & edit
      document.getElementById('productSearchBtn')?.addEventListener('click', async () => {
        const q = document.getElementById('productQuery').value.trim();
        if (!q) return alert('Enter search query');
        try {
          const r = await fetch('/api/products/search', {
            method: 'POST',
            headers,
            body: JSON.stringify({ query: q })
          });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Search failed');
          renderProductResults(j.products || []);
        } catch (err) {
          alert('Search error: ' + err.message);
        }
      });

      function renderProductResults(products) {
        const container = document.getElementById('productResults');
        if (!products || !products.length) { container.innerHTML = '<p>No products found</p>'; return; }
        container.innerHTML = products.map(p => `
          <div style="padding:8px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;">
            <div style="display:flex;gap:12px;align-items:center;">
              <img src="${p.image || '/images/placeholder.png'}" style="width:48px;height:48px;object-fit:cover;border-radius:6px;" />
                <div>
                <div style="font-weight:600">${p.title}</div>
                <div style="font-size:12px;color:#666">ID: ${p._id}</div>
                <div style="font-size:12px;color:#666">Address: ${p.address || ''}</div>
                <div style="font-size:12px;color:#666">Phone: ${p.phone_number || ''}</div>
              </div>
            </div>
            <div>
              <button onclick="loadProductForEdit('${p._id}')" class="small">Edit</button>
              <button onclick="deleteProduct('${p._id}')" class="small" style="margin-left:8px;background:#fca5a5">Delete</button>
            </div>
          </div>
        `).join('');
      }

      // Delete product (admin)
      window.deleteProduct = async function (id) {
        if (!confirm('Delete this product? This action cannot be undone.')) return;
        try {
          const r = await fetch('/api/products/' + id, { method: 'DELETE', headers });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Delete failed');
          alert('Product deleted');
          // remove from results list visually
          const q = document.getElementById('productQuery').value.trim();
          if (q) document.getElementById('productSearchBtn').click();
        } catch (err) {
          alert('Delete error: ' + err.message);
        }
      };

      // Delete user (admin)
      window.deleteUser = async function (id) {
        if (!confirm('Delete this user and their products?')) return;
        try {
          const r = await fetch('/api/auth/users/' + id, { method: 'DELETE', headers });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Delete failed');
          alert('User deleted');
          loadUsers();
        } catch (err) {
          alert('Delete error: ' + err.message);
        }
      };

      window.loadProductForEdit = async function (id) {
        try {
          const r = await fetch('/api/products/' + id, { headers });
          const p = await r.json();
          if (!r.ok) throw new Error(p.message || 'Failed to load product');
          // populate form
          document.getElementById('editId').value = p._id;
          document.getElementById('editTitle').value = p.title || '';
          document.getElementById('editDescription').value = p.description || '';
          document.getElementById('editPrice').value = p.price ?? 0;
          document.getElementById('editQuantity').value = p.quantity ?? 0;
          document.getElementById('editCategory').value = p.category || '';
          document.getElementById('editImage').value = p.image || '';
          document.getElementById('editAddress').value = p.address || '';
          document.getElementById('editPhone').value = p.phone_number || '';
          document.getElementById('editProductForm').style.display = 'block';
          // scroll into view
          document.getElementById('editProductForm').scrollIntoView({ behavior: 'smooth' });
        } catch (err) {
          alert('Error loading product: ' + err.message);
        }
      };

      document.getElementById('cancelEditBtn')?.addEventListener('click', () => {
        document.getElementById('editProductForm').style.display = 'none';
      });

      document.getElementById('saveProductBtn')?.addEventListener('click', async () => {
        const id = document.getElementById('editId').value;
        if (!id) return alert('No product selected');
          const payload = {
            title: document.getElementById('editTitle').value,
            description: document.getElementById('editDescription').value,
            price: parseFloat(document.getElementById('editPrice').value) || 0,
            quantity: parseInt(document.getElementById('editQuantity').value) || 0,
            category: document.getElementById('editCategory').value,
            address: document.getElementById('editAddress').value,
            phone_number: document.getElementById('editPhone').value,
            image: document.getElementById('editImage').value
        };
        try {
          const r = await fetch('/api/products/' + id, { method: 'PUT', headers, body: JSON.stringify(payload) });
          const j = await r.json();
          if (!r.ok) throw new Error(j.message || 'Save failed');
          alert('Product updated');
          document.getElementById('editProductForm').style.display = 'none';
        } catch (err) {
          alert('Save error: ' + err.message);
        }
      });

      // Initial load
      loadUsers();
    </script>
  </body>
</html>
